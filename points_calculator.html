<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title></title>
<script src="bestiary.js"></script>
<script>
function strings_to_constants(acc, item) {
	acc[item] = item;
	return acc;
}
// charms
var c = ["universal_good", "charms_x2", "gems_x1", "spices_x1", "beasts_x1", "weapons_x1", 
  "unicorn_x2", "phoenix_x2", "spider_x2", "sea_serpent_x2",
  "mint_cloves_x4", "mint_anise_x4", "mint_chili_x4", "lotus_anise_x4",
  "cloves_lotus_x4", "cloves_juniper_x4", "juniper_chili_x4",
  "anise_juniper_x4", "chili_lotus_x4",
  "katar_x2", "boomerang_x2", "pingu_x2", "shuriken_x2",
  "five_goods_x4", "three_beasts_x4", "gem_spinner", "counter_weapon"].reduce(strings_to_constants, {});
/*
var c_count = { 
	c.universal_good: 4,
	c.counter_weapon: 2,
	c.charms_x2: 3,
	c.gems_x1: 3,
	c.spices_x1: 3,
	c.beasts_x1: 3,
	c.weapons_x1: 3,
	c.unicorn_x2: 2, 
	c.phoenix_x2: 2,
	c.spider_x2: 2,
	c.sea_serpent_x2: 2,
	
	c.five_goods_x4: 2,
	c.three_beasts_x4: 2,
	c.katar_x2: 1,
	c.pingu_x2: 1,
	c.boomerang_x2: 1,
	c.shuriken_x2: 1,
	c.gem_spinner: 2,
}; */

// spices
var s = ["anise","mint","chili","juniper","lotus","cloves"].reduce(strings_to_constants, {});
// beasts
var beast_names = ["unicorn","phoenix","spider","sea_serpent"];
var b = beast_names.reduce(strings_to_constants, {});
// weapons
var w = ["katar","pingu","boomerang","shuriken"].reduce(strings_to_constants, {});

// card encodings
// katar10 means katar +2 +2, katar2 means katar 0 +2 etc.
var cards_deck = {
	0: [c.three_beasts_x4],
	1: [c.spices_x1, 6, s.chili, b.phoenix, w.katar + 5],
	3: [c.phoenix_x2, 1, s.cloves, b.spider, w.katar + 9],
	4: [c.katar_x2, 7, s.mint, b.spider, w.katar + 6],
	5: [c.weapons_x1, 4, s.anise, b.unicorn, w.katar + 6],
	8: [c.universal_good, 3, s.mint, b.sea_serpent, w.katar + 5],
	9: [c.charms_x2, 8, s.anise, b.phoenix, w.katar + 8],
	11: [c.gems_x1, 5, s.cloves, b.sea_serpent, w.katar + 2],
	12: [c.five_goods_x4, 2, s.chili, b.unicorn, w.katar + 2],
	13: [c.boomerang_x2, 1, s.anise, b.sea_serpent, w.boomerang + 9],
	15: [c.spider_x2, 5, s.lotus, b.unicorn, w.boomerang + 9],
	16: [c.weapons_x1, 8, s.mint, b.phoenix, w.boomerang + 6],
	18: [c.charms_x2, 7, s.chili, b.spider, w.boomerang + 6],
	20: [c.universal_good, 5, s.anise, b.spider, w.boomerang + 5],
	23: [c.beasts_x1, 1, s.lotus, b.phoenix, w.boomerang + 2],
	26: [c.gems_x1, 2, s.juniper, b.spider, w.pingu + 5],
	27: [c.phoenix_x2, 5, s.chili, b.sea_serpent, w.pingu + 9],
	28: [c.pingu_x2, 3, s.lotus, b.unicorn, w.pingu + 6],
	29: [c.sea_serpent_x2, 2, s.mint, b.phoenix, w.pingu + 6],
	30: [c.mint_chili_x4, 4, s.cloves, b.phoenix, w.pingu + 6],
	33: [c.charms_x2, 6, s.mint, b.unicorn, w.pingu + 8],
	34: [c.counter_weapon, 3, s.anise, b.spider, w.pingu + 8],
	35: [c.mint_anise_x4, 1, s.chili, b.spider, w.pingu + 2],
	36: [c.universal_good, 7, s.lotus, b.phoenix, w.pingu + 2],
	37: [c.shuriken_x2, 5, s.juniper, b.phoenix, w.shuriken + 9],
	38: [c.phoenix_x2, 6, s.anise, b.unicorn, w.shuriken + 9],
	40: [c.beasts_x1, 8, s.chili, b.unicorn, w.shuriken + 6],
	41: [c.unicorn_x2, 7, s.cloves, b.sea_serpent, w.shuriken + 6],
	42: [c.chili_lotus_x4, 5, s.mint, b.spider, w.shuriken + 6],
	43: [c.three_beasts_x4, 6, s.lotus, b.spider, w.shuriken + 5],
	44: [c.weapons_x1, 3, s.cloves, b.spider, w.shuriken + 5],
	46: [c.universal_good, 1, s.juniper, b.unicorn, w.shuriken + 8],
	47: [c.gem_spinner, 1, s.mint, b.sea_serpent, w.shuriken + 2],
	48: [c.cloves_lotus_x4, 2, s.anise, b.phoenix, w.shuriken + 2],
}
var good_types = {
	"gems": 1,
	"spices": 2,
	"beasts": 3,
	"weapons": 4
}
var spice_points = [0, 2, 4, 8, 12, 20, 30];
function weapon_stats(good) {
	var strength = good.endsWith("10") ? 10 : parseInt(good.substr(good.length - 1, good.length), 10);
	return {
		wname: good.substr(0, good.length - (strength === 10 ? 2 : 1)),
		wvalue: [strength / 4 | 0, strength % 4]
	};
}
function classify_helper(acc, good_card) {
	var good_index = good_types[this];
	var good = cards_deck[good_card][good_index];
	if (good_index === 4) {
		good = weapon_stats(good).wname;
	}
	if (acc[good] !== undefined) {
		acc[good]++;
	} else {
		acc[good] = 1;
	}
	return acc;	
}
function classify(cards, good_name) {
	return cards[good_types[good_name]].reduce(classify_helper.bind(good_name), {});
}

function count_points(players, beast_memo) {
	return players.reduce(function (acc, cards) {
		var beasts = classify(cards, "beasts");
		var spices = classify(cards, "spices");
		var weapons = classify(cards, "weapons");
		var gems = classify(cards, "gems");
		console.log(beasts);
		console.log(spices);
		console.log(gems);
		var weapons_strength = Object.keys(weapons).reduce(function (acc1, weapon) {
			if (weapons[weapon] === 1) {
				acc1[weapon] = cards[4].reduce(function (acc2, weapon_card) {
					var stats = weapon_stats(cards_deck[weapon_card][4]);
					if (stats.wname === weapon) {
						acc2 = stats.wvalue;
					}
					return acc2;
				}, [0, 0])
			}
			return acc1;
		}, {});
		console.log(weapons);
		
		var total_points = cards[0].reduce(function (acc1, charm_card) {
			var charm = cards_deck[charm_card][0];
			console.log(charm);
			if (charm === c.universal_good) {
				throw "Universal goods should be converted to chosen goods";
			} else if (charm === c.charms_x2) {
				acc1.points += cards[0].length * 2;				
			} else if (charm.endsWith("_x2")) {
				var good_name = charm.substr(0, charm.length - 3);
				acc1.points += (beasts[good_name] || 0)*2;
				if (weapons_strength[good_name]) {
					weapons_strength[good_name] = weapons_strength[good_name].reduce(function (acc2, value) {
						acc2.push(value + 2);
						return acc2;
					}, []);
				}
			} else if (charm.endsWith("_x4")) {
				if (charm === c.five_goods_x4) {
					// min number of each good kind multiplied by 4
					acc1.points += cards.reduce(function (acc2, goods) {
						acc2 = Math.min(acc2, goods.length);
						return acc2;
					}, 12) * 4;
				} else if (charm === c.three_beasts_x4) {
					// how many times can we pick 3 different beasts?
					var beasts1 = Object.assign({}, beasts), beast_count = 0;
					while (beast_counter(beasts1) && beast_count < 4) {
						acc1.points += 4;
						console.log(beasts1);
						beast_count++;
					}
				} else {
					// combination of spices
					bonus_spices = /^([a-z]+)_([a-z]+)/.exec(charm);
					acc1.points += Math.min(spices[bonus_spices[1]] || 0, spices[bonus_spices[2]] || 0) * 4;
					var print_spices = {};
					print_spices[bonus_spices[1]] = spices[bonus_spices[1]];
					print_spices[bonus_spices[2]] = spices[bonus_spices[2]];
					console.log(print_spices);
				}
			} else if (charm.endsWith("_x1")) {
				var good_type = charm.substr(0, charm.length - 3);	
				acc1.points += cards[good_types[good_type]].length;
			} else if (charm === c.gem_spinner) {
				acc1.spinner = true;
			} else if (charm === c.counter_weapon) {
				// choose the strongest against this player
			}
			console.log("charm points=" + acc1.points);
			return acc1;
		}, {spinner: false, points: 0});
		console.log(weapons_strength);
		var gem_points = 0;
		// TODO process gem_spinner (if any) and count gem points
		var beast_points = beast_memos[beast_memo](cards[3], beasts), points4spices = spice_points[Object.keys(spices).length];
		total_points.points += beast_points + points4spices;
		console.log("spice points=" + points4spices);
		console.log("beast points=" + beast_points);
		console.log("total points=" + total_points.points);
		acc.push(total_points);
		return acc;
	}, []);
}

// console.log(count_points([[[27, 0, 30, 37, 35, 12], [1, 8], [27, 1], [11, 12, 20, 26, 29, 42], [46, 47]]], 3));
// console.log(count_points([[[], [], [], [], []], [[], [], [], [], []]], 3));
console.log(count_points([[[4], [33, 42], [5, 18, 23], [20, 34, 38, 40], [3, 37]], [[9, 16, 44], [15, 30], [47, 48], [11, 13, 28], [8, 40]]], 3));
</script>
</head>

<body>
</body>
</html>